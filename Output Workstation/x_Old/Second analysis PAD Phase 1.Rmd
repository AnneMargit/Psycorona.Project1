---
title: "Second analysis PAD Phase 1"
author: "Anne Margit"
date: "10/15/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, set-options, echo=FALSE, cache= FALSE}
options(width=1000)
Sys.getenv('R_MAX_VSIZE')
```

```{r, results = "hide"}
load("data_analyse2_p1.Rdata")
```

This dataset includes:

1. Data from all weekly measurement waves (baseline through wave 11, Time 1 through 12) 
2. Participants who provided at least 3 measurements 
3. Participants who are residents of the country they currently live in
4. Participants who provided info on age
5. Participants who provided info on gender (either male or female)
6. Data from countries with at least 20 participants
7. Pooled age groups
8. Imputed missing emotion scores
9. Combined emotion scores (NAA, NAD, PAA, PAD)
10. An imputed Stringency index (StringencyIndex_imp) 
11. A variable indicating the number of days before and after the day on which maximum stringency was reached for the respective country (DaysMax)
12. A variable indicating the number of weeks before and after the day on which maximum stringency was reached for the respective country (WeeksMax)
13. A variable indicating the date on which maximum Stringency was reached for that country (DateMaxStr)
14. A dummy Str_dummy with 0 = before the peaj, 1 = during peak, 2 = after peak
15. Observations during which there was a second peak are excluded (N=583) 

> My comments are in block quotes such as this. 

```{r, message=F}
library(dplyr)
library(tidyverse)
library(ggpubr)
library(ggplot2)
library(rockchalk)
library(effects)
library(nlme)
library(lattice)
library(broom.mixed)
library(purrr)
```

# Descriptives
**Number of participants per age group**
```{r, message=F, comment=NA}
data_analyse2_p1 %>%
  group_by(Age_new) %>%
  summarise(NAge = n())
```

**Plots**
**Mean PAD against max stringency in WEEKS**
```{r, echo=T, message=F, warning=F}
plot_PAD <- ggplot(data_analyse2_p1, aes(x=WeeksMax_p1, y=PAD, group = Age_new, color = Age_new))

plot_PAD + stat_summary(fun.y=mean, geom="line", size=1)  + geom_errorbar(stat="summary", fun.data="mean_se", width=0) + scale_colour_discrete(name = "Age", labels = c("18-24", "25-44", "45-64", "65+")) + expand_limits(y=c(1, 5))
```

**Mean PAD against max stringency in DAYS**
```{r, echo=T, message=F, warning=F}
plot_PAD <- ggplot(data_analyse2_p1, aes(x=DaysMax_p1, y=PAD, group = Age_new, color = Age_new))

plot_PAD + stat_summary(fun.y=mean, geom="line", size=1)  + geom_errorbar(stat="summary", fun.data="mean_se", width=0) + scale_colour_discrete(name = "Age", labels = c("18-24", "25-44", "45-64", "65+")) + expand_limits(y=c(1, 5))
```

# Regression models phase 1

**Positive affect low arousal**

*Predictors: DaysMax_p1, Age, Random: IC for Country*
```{r, message=F, comment=NA}
model_PAD1 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                   random = ~1 | Country, 
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD1)
```

*Predictors: DaysMax_p1, Age, Random: IC for ID*
```{r, message=F, comment=NA}
model_PAD2 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = ~1 | ID, 
                 data = data_analyse2_p1, 
                 na.action = na.omit)

summary(model_PAD2)
```

*Random: IC for ID and Country*
```{r, message=F, comment=NA}
model_PAD3 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = ~1 | Country/ID, 
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD3)
```

*Random: IC for ID and Country, S for Country*
```{r, message=F, comment=NA}
model_PAD4 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list (Country = ~DaysMax_p1, ID = ~1), 
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD4)
```

*Random: IC for ID and Country, S for ID*
```{r, message=F, comment=NA}
model_PAD5 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list (Country = ~1, ID = ~DaysMax_p1), 
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD5)
```

*Random slope for Country and ID*
```{r, message=F, comment=NA}
model_PAD6 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = ~DaysMax_p1 | Country/ID, 
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD6)
```

> The models only differ slightly in BIC scores.

*Random: IC for ID and Country, S for Country, No correlation between IC and S for Country*
```{r, message=F, comment=NA}
model_PAD7 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list(Country = pdDiag(~DaysMax_p1), ID = ~1), 
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD7)
```

*Random: IC for ID and Country, S for ID, No correlation between IC and S for ID*
```{r, message=F, comment=NA}
model_PAD8 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list(Country = ~1, ID = pdDiag(~DaysMax_p1)), 
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD8)
```

*Random: IC for ID and Country, S for ID and Country, No correlation between IC and S for Country and ID*
```{r, message=F, comment=NA}
model_PAD9 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list (Country = pdDiag(~DaysMax_p1), ID = pdDiag(~DaysMax_p1)),
                  data = data_analyse2_p1, 
                  na.action = na.omit)

summary(model_PAD9)
```

> Best model is PAD7: random IC for ID and Country + S for Country + no correlation between IC and S for Country*

*Random: IC for ID and Country, S for Country, No correlation between IC and S for Country + AR*
```{r, message=F, comment=NA}
data_analyse2_p1 <- data_analyse2_p1[with(data_analyse2_p1, order(Country, ID, Time)),]
data_analyse2_p1$Time <- as.numeric(data_analyse2_p1$Time)

model_PAD10 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list(Country = pdDiag(~DaysMax_p1), ID = ~1), 
                  data = data_analyse2_p1, 
                  na.action = na.omit,
                  correlation = corAR1(form = ~ Time | Country/ID))

summary(model_PAD10)
```

*Random: IC for ID and Country, S for Country + AR*
```{r, message=F, comment=NA}
model_PAD11 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list(Country = ~DaysMax_p1, ID = ~1), 
                  data = data_analyse2_p1, 
                  na.action = na.omit,
                  correlation = corAR1(form = ~ Time | Country/ID))

summary(model_PAD11)
```

*Random: IC for ID and Country, S for Country and ID + AR*
```{r, message=F, comment=NA}
model_PAD12 <- lme(fixed = PAD ~ DaysMax_p1 + Age_new + DaysMax_p1*Age_new,
                  random = list(Country = ~DaysMax_p1, ID = ~DaysMax_p1), 
                  data = data_analyse2_p1, 
                  na.action = na.omit,
                  correlation = corAR1(form = ~ Time | Country/ID))

summary(model_PAD12)
```

> Model PAD10 has the best fit (lowest BIC). Random IC for ID and Country, S for Country, No correlation between IC and S for Country + AR

*QQ plot of residuals*
```{r, message=F, comment=NA}
par(mfrow = c(1,2))
lims <- c(-3.5,3.5)
hist(resid(model_PAD10, type = "normalized"),
freq = FALSE, xlim = lims, ylim =  c(0,.7),main = "Histogram of Standardized Residuals")
lines(density(scale(resid(model_PAD10))))
qqnorm(resid(model_PAD10, type = "normalized"),
xlim = lims, ylim = lims,main = "QQ plot")
abline(0,1, col = "red", lty = 2)
```

*Residuals vs fitted*
```{r, message=F, comment=NA}
plot(fitted(model_PAD10, level=2), residuals(model_PAD10, level=2), 
     main="residuals vs fitted at ID level")
abline(a=0, b=0,col="red")
plot(fitted(model_PAD10, level=1), residuals(model_PAD10, level=1), 
    main="residuals vs fitted at Country level")
abline(a=0, b=0,col="red")
```

> Residuen zien er allemaal goed uit

*Plot random intercepts and slopes*
```{r, message=F, comment=NA}
plot(ranef(model_PAD10, level = 1))
plot(ranef(model_PAD10, level = 2))
```

*Confidence intervals*
```{r, message=F, comment=NA}
intervals(model_PAD10)
```
*Plot of predicted values*
```{r, results = "hide", message=F}
ef_PAD <- effect("DaysMax_p1:Age_new", model_PAD10)

plot_PAD <- ggplot(as.data.frame(ef_PAD), 
       aes(DaysMax_p1, fit, color=Age_new)) + geom_line() + 
  geom_errorbar(aes(ymin=fit-se, ymax=fit+se), width=1) + theme_bw(base_size=12) + scale_color_discrete(name="Age", labels = c("18-24", "25-44", "45-64", "65+")) + expand_limits(y=c(1, 5))
```

```{r, message=F}
plot_PAD
```

```{r, message=F, comment=NA}
coef_PAD = tidy(model_PAD10, 
               effects = "fixed")
```

*Effect sizes*
**Within person SD and average within person SD of NAA**
```{r, message=F, comment=NA}
ISDs <- data_analyse2_p1 %>% 
  group_by(ID) %>%
  summarize_at(c("PAD"), sd, na.rm=TRUE) %>%
  ungroup()

ISDs_av <- ISDs %>%
  summarize_at(c("PAD"), mean, na.rm=TRUE) %>%
  stack() %>%
  rename(sd=values) 
```
> Effect sizes for intercept and main effect of age = regression coefficient / average ISD of PAD
> Effect size for main effect of DaysMax = (regression coefficient * 28)/ average ISD of PAD
> Effect sizes for interaction effects = (regression coefficient * 28)/ average ISD of PAD

> The effect sizes for main effect of DaysMax and the interaction effects reflect the increase in SD of PAD over 4 weeks (28 days)

```{r, message=F, comment=NA}
coef_PAD <- coef_PAD %>%
  mutate(e_size = ifelse(row_number()== 1 | row_number()== 3 |  row_number()== 4 |  row_number()== 5,
          estimate/0.5048412, 
          (estimate*28)/0.5048412))
         
```

```{r}
coef_PAD
```

> There are differences between the youngest age group (control) and the 25-44 year olds, and between the youngest and the oldest age groups. In the plot there seems to be an effect over time and an interaction effect but this is not significant. 


